if(typeof(PTAllowedHandler)=="undefined"){PTAllowedHandler={}}(function(){PTAllowedHandler.init=function(b){PageConfig.isProcess=false;JsCache.get("#yourPT").text(b);if(PageConfig.agentLevel==UserType.MASTER_AGENT.value){JsCache.get("#memberMaxPT").val(0).parents(".pt_allowed").hide()}PTAllowedHandler.bindEvent()};PTAllowedHandler.bindEvent=function(){JsCache.get("#memberMaxPT").blur(function(){var c=$j(this);var b=PTAllowedHandler.getMemberMaxPTLimit();PTAllowedHandler.checkPTNumber(c,b)});JsCache.get("#sportsSet input").keyup(function(c){if(!KeyEventUtils.isEnterKey(c.keyCode)){var e=$j(this);var b=e.val();if(!ValidateDataUtil.isEmpty(b)){var d=PTAllowedHandler.getPtSettingLimit();if(PTAllowedHandler.checkPTNumber(e,d)){if(e.attr("id")=="allowMaxPT"){JsCache.get("#sportsSet input:gt(0)").each(function(){var f=$j(this);PTAllowedHandler.removeError(f);f.val(parseInt(b))})}}}else{PTAllowedHandler.removeError(e)}}});JsCache.get("#fancyBetSet input").keyup(function(){if(!KeyEventUtils.isEnterKey(event.keyCode)){a($j(this))}});JsCache.get("#sportsSet input:gt(0)").blur(function(){var c=$j(this);var b=c.val();if(ValidateDataUtil.isEmpty(b)||isNaN(b)){c.val("0");PTAllowedHandler.removeError(c)}});JsCache.get("#fancyBetSet input").blur(function(){var c=$j(this);var b=c.val();if(ValidateDataUtil.isEmpty(b)||isNaN(b)){c.val("0");PTAllowedHandler.removeError(c)}});JsCache.get("#sportsSet .up").click(function(){PTAllowedHandler.changePercentage($j(this),false)});JsCache.get("#sportsSet .down").click(function(){PTAllowedHandler.changePercentage($j(this),false)});JsCache.get("#fancyBetSet .up").click(function(){PTAllowedHandler.changePercentage($j(this),true);var b=$j(this).parents("dd").find("input");a(b)});JsCache.get("#fancyBetSet .down").click(function(){PTAllowedHandler.changePercentage($j(this),true);var b=$j(this).parents("dd").find("input");a(b)})};function a(g){var b=g.val();if(!ValidateDataUtil.isEmpty(b)){var e=g.data("type");var c="company";if("company"==e){c="shareHolder"}var f=PTAllowedHandler.getFancyPtSettingLimit();var d=$j("#"+c+"_fancy_bet_PT");d.val((f-b));PTAllowedHandler.checkFancyBetPTSet()}else{PTAllowedHandler.removeError(g)}}PTAllowedHandler.showDialog=function(){var b;if(PageConfig.agentLevel==UserType.COMPANY.value){b=PageConfig.member.memberCurrencyType}$j.ajax({type:"POST",url:"/agent/memberManagementController/querySelfInfo",data:{action:"pt",currency:b},success:function(d){if(d.error){NoticeHandler.error(d.error)}else{PageConfig.agentPT=d.maxBackPT;JsCache.get("#yourPT").text(PageConfig.agentPT);JsCache.get("#memberMaxPT").val(PageConfig.member.memberPT);for(var f in PageConfig.member.sportPTs){JsCache.get("#"+f+"_PT").val(PageConfig.member.sportPTs[f])}var c=PageConfig.member.fancyBetPTs[EventType.CRICKET.name.toLowerCase()];var e=$j("#company_fancy_bet_PT");e.val(parseInt(c));a(e);JsCache.get("#changePTModal").delegate("#changePTBtn","click",function(){PTAllowedHandler.check(PageConfig.member.userID,PageConfig.memberSite)});$j(document).bind("keydown",function(g){if(KeyEventUtils.isEnterKey(g.keyCode)&&!PageConfig.isProcess){$j("#changePTBtn").click()}});JsCache.get("#changePTModal").show()}}})};PTAllowedHandler.hideDialog=function(){JsCache.get("#changePTModal").hide();$j(document).unbind("keydown");JsCache.get("#changePTModal").undelegate("#changePTBtn","click");PTAllowedHandler.resetValue()};PTAllowedHandler.resetValue=function(){JsCache.get("#memberMaxPT").removeClass("error").val("0");JsCache.get("#sportsSet input").removeClass("error").val("0");JsCache.get("#sportsSet .tips-popup").hide();JsCache.get("#fancyBetSet .tips-popup").hide()};PTAllowedHandler.check=function(d,c){try{PageConfig.isProcess=true;var b=PTAllowedHandler.getSportPTData();if(typeof(b)=="undefined"){return false}var g=PTAllowedHandler.getCompanyFancyBetPtPercentage();if(null==g){return false}$j.ajax({type:"POST",url:"/agent/memberManagementController/changePT",data:{userID:d,site:c,sportPTs:b,companyFancyBetPtPercentage:g},beforeSend:function(){JsCache.get("#changePTBtn").hide();JsCache.get("#changePTBtn").prop("disabled",true);JsCache.get("#loading").show()},complete:function(){JsCache.get("#changePTBtn").prop("disabled",false);PageConfig.isProcess=false;JsCache.get("#changePTBtn").show();JsCache.get("#loading").hide()},success:function(k){if(k.error!=null){var h;if(k.error[0]=="["){h="";var e=JSON.parse(k.error);for(var i in e){h+=e[i]+"\n"}}else{h=k.error}NoticeHandler.error(h)}else{JsCache.get("#sportsSet input:gt(0)").each(function(){var n=$j(this);var m=n.attr("id");JsCache.get("#profile_"+m).text(n.val()+"%");PageConfig.member.sportPTs[m.replace("_PT","")]=n.val()});PageConfig.member.memberPT=JsCache.get("#memberMaxPT").val();var l=JsCache.get("#profile_pt_allowed");if(l){l.text(PageConfig.member.memberPT+"%")}var j=$j("#company_fancy_bet_PT").val().trim();JsCache.get("#profile_company_fancy_bet_PT").text(j+"%");PageConfig.member.fancyBetPTs[EventType.CRICKET.name.toLowerCase()]=j;PTAllowedHandler.hideDialog();NoticeHandler.success(I18N.get("msg.executeSuccessful.executeSuccessfully"))}},error:function(i,e,h){Trace.log(i.status);Trace.log(h);return}})}catch(f){NoticeHandler.error(f.message)}};PTAllowedHandler.checkPTSet=function(){var b=false;var c=$j("#memberMaxPT");var e=PTAllowedHandler.getMemberMaxPTLimit();if(PTAllowedHandler.checkPTNumber(c,e)){b=true}else{b=false;return false}e=PTAllowedHandler.getPtSettingLimit();var d=$j("#allowMaxPT");if(!ValidateDataUtil.isEmpty(d.val())){if(PTAllowedHandler.checkPTNumber(d,e)){b=true}else{b=false;return false}}$j("#sportsSet input:gt(0)").each(function(){var f=$j(this);if(!PTAllowedHandler.checkPTNumber(f,e)){b=false;return false}});return b};PTAllowedHandler.checkFancyBetPTSet=function(){var b=true;var c=PTAllowedHandler.getFancyPtSettingLimit();$j("#fancyBetSet input").each(function(){var d=$j(this);if(!PTAllowedHandler.checkPTNumber(d,c)){b=false;return false}});return b};PTAllowedHandler.checkPTNumber=function(h,f){var i="fancyBetSet"==h.parents(".sports_set").prop("id");var k=PageConfig.ptMultiple;if(i){k=PageConfig.fancyBetPtMultiple}var b=h.parent().prev().text().trim();try{var c=h.val().trim();if(ValidateDataUtil.isEmpty(c)||isNaN(c)){throw new NotValidException(I18N.get("msg.error.validation.mustBeNumber",[b]))}if(!MathUtil.isPositive(c)){throw new NotValidException(I18N.get("msg.error.validation.positive",[b]))}var j=parseInt(c.split(".")[0]);var d=h.nextAll(".tips-popup");if(d.length){if(j%k>0){d.show();return false}else{d.hide()}}else{if(j%k>0){throw new NotValidException(I18N.get("msg.error.validation.ptSettingMustBeMultiplierOf5",[b]))}}f=f<0?0:f;if(j>parseInt(f)){throw new NotValidException(I18N.get("msg.error.validation.notGreater",[f,b]))}h.val(j);h.removeClass("error");return true}catch(g){h.addClass("error");NoticeHandler.error(g.message);return false}};PTAllowedHandler.getSportPTData=function(){if(PTAllowedHandler.checkPTSet()){var b={};b.memberMaxPT=$j("#memberMaxPT").val();b.sportSet={};$j("#sportsSet input:gt(0)").each(function(){var e=$j(this);var c=e.data("type");var d=e.val();b.sportSet[c]=d});return JSON.stringify(b)}};PTAllowedHandler.getCompanyFancyBetPtPercentage=function(){if(PageConfig.agentLevel!=UserType.COMPANY.value){return 0}var d=PTAllowedHandler.getFancyPtSettingLimit();if(PTAllowedHandler.checkFancyBetPTSet()){var c=parseInt($j("#company_fancy_bet_PT").val().trim());var b=parseInt($j("#shareHolder_fancy_bet_PT").val().trim());if(d!=(c+b)){return null}return c}return null};PTAllowedHandler.changePercentage=function(h,d){var e=h.parents("dd");var i=e.find("input");var b=i.val();if(ValidateDataUtil.isEmpty(b)||isNaN(b)){b="0"}else{var c=PageConfig.ptMultiple;if(d){c=PageConfig.fancyBetPtMultiple}b=parseInt(b);var g=b%c;if(h.hasClass("up")){if(g>0){b=b-(g)}b=b+c}else{if(g>0){b=b-(g)}else{b=b-c}}var f=PTAllowedHandler.getPtSettingLimit();if(d){f=PTAllowedHandler.getFancyPtSettingLimit()}if(b<0){b=0}else{if(b>f){b=f}}}NoticeHandler.hide();i.val(b);i.removeClass("error");e.find(".tips-popup").hide();if(i.attr("id")=="allowMaxPT"){JsCache.get("#sportsSet input:gt(0)").each(function(){var j=$j(this);PTAllowedHandler.removeError(j);j.val(b)})}};PTAllowedHandler.getMemberMaxPTLimit=function(){return PageConfig.agentLevel==UserType.COMPANY.value?PageConfig.agentPT:PageConfig.agentPT-PageConfig.ptSavingQuota};PTAllowedHandler.getPtSettingLimit=function(){return PageConfig.agentPT>0?PageConfig.agentPT:0};PTAllowedHandler.getFancyPtSettingLimit=function(){return PageConfig.fancyBetSystemPtPercentage};PTAllowedHandler.removeError=function(b){b.removeClass("error");b.nextAll(".tips-popup").hide()}})();